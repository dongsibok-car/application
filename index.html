<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동시복 이동지원신청</title>
    <!-- Tailwind CSS 스크립트 추가 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <!-- 신청 폼 컨테이너 -->
    <div class="w-full max-w-2xl bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200">
        <!-- 헤더 -->
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-blue-600 mb-6">
            동시복<br class="sm:hidden"> 이동지원신청
        </h1>
        <p class="text-center text-gray-500 mb-8">
            신청 정보를 정확하게 입력해 주세요.
        </p>

        <!-- 신청 폼 -->

<form id="applicationForm" class="space-y-6">
    <div>
        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">이름</label>
        <input type="text" id="name" name="name" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
    </div>

    <div>
        <label for="contact" class="block text-sm font-medium text-gray-700 mb-1">연락처</label>
        <input type="tel" id="contact" name="contact" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200" placeholder="예: 010-1234-5678">
    </div>

    <div>
        <label for="tripDate" class="block text-sm font-medium text-gray-700 mb-1">탑승날짜</label>
        <input type="date" id="tripDate" name="tripDate" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
    </div>

    <div>
        <label for="program" class="block text-sm font-medium text-gray-700 mb-1">이용 프로그램</label>
        <select id="program" name="program" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            <option value="" disabled selected>프로그램을 선택해 주세요</option>
            <option value="아이폰_집합교육">[자립] 아이폰 집합교육</option>
            <option value="원데이_클래스">[평생] 원데이 클래스</option>
            <option value="댄스_교실">[평생] 댄스 교실</option>
            <option value="오카리나">[자립] 오카리나</option>
            <option value="우쿨렐레">[자립] 우쿨렐레</option>
            <option value="함께걷기_고고고">[지역] 함께걷기 고고고</option>
            <option value="기타">[전체] 기타</option>
        </select>
    </div>
    
    <div>
        <label for="boardingLocation" class="block text-sm font-medium text-gray-700 mb-1">탑승장소 및 시간</label>
        <select id="boardingLocation" name="boardingLocation" required class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200">
            <option value="" disabled selected>탑승장소 및 시간을 선택해 주세요</option>
            <option value="회기역 2번 출구 - 09:30 출발">회기역 2번 출구 - 09:30 출발</option>
            <option value="복지관 - 13:10 출발">복지관 - 13:10 출발</option>
            <option value="회기역 2번 출구 - 13:30 출발">회기역 2번 출구 - 13:30 출발</option>
        </select>
    </div>
    
    <div>
        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">하고 싶은 말 (선택)</label>
        <textarea id="notes" name="notes" rows="4" class="mt-1 block w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"></textarea>
    </div>

    <div>
        <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
            신청하기
        </button>
    </div>

    <div class="flex items-center">
    <input type="checkbox" id="privacyConsent" name="privacyConsent" required class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
    <label for="privacyConsent" class="ml-2 block text-sm text-gray-900">
        개인정보 수집 및 이용에 동의합니다.
    </label>
    </div>

</form>

        <!-- 성공 메시지 -->
        <div id="successMessage" class="hidden mt-6 text-center">
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative" role="alert">
                <strong class="font-bold">신청 완료!</strong>
                <span class="block sm:inline">신청이 성공적으로 접수되었습니다.</span>
            </div>
        </div>
    </div>
    
    <script>
    const form = document.getElementById('applicationForm');
    const successMessage = document.getElementById('successMessage');
    const tripDateInput = document.getElementById('tripDate');
    const boardingLocationSelect = document.getElementById('boardingLocation');
    const submitButton = form.querySelector('button[type="submit"]');

    // 신청 인원 표시할 요소 추가 (선택사항)
    const countDisplay = document.createElement('p');
    countDisplay.className = 'text-center text-sm font-semibold mt-2';
    boardingLocationSelect.after(countDisplay);

    // 이 URL을 본인이 배포한 Google Apps Script의 'exec' URL로 교체해야 합니다.
    let appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzIHfra_R9huoJ4M7vB3nRJvALhL2Z0yXyS-w9_zdBOcGyBqp4-rr7U-V42NZcqg-YMOg/exec';

    const checkAvailability = async () => {
        const selectedDate = tripDateInput.value;
        const selectedLocation = boardingLocationSelect.value;
        
        if (!selectedDate || !selectedLocation) {
            countDisplay.textContent = '';
            submitButton.disabled = false;
            submitButton.textContent = '신청하기';
            submitButton.classList.remove('bg-gray-400', 'hover:bg-gray-400');
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            return;
        }

        try {
            const response = await fetch(`${appsScriptUrl}?action=getCount&date=${encodeURIComponent(selectedDate)}&location=${encodeURIComponent(selectedLocation)}`);
            const data = await response.json();
            const count = data.count;
            const limit = 9;

            countDisplay.textContent = `현재 ${count}명 신청 / 총 ${limit}명 정원`;
            
            if (count >= limit) {
                countDisplay.textContent += ' (마감)';
                countDisplay.classList.add('text-red-600');
                submitButton.disabled = true;
                submitButton.textContent = '마감되었습니다';
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitButton.classList.add('bg-gray-400', 'hover:bg-gray-400');
            } else {
                countDisplay.classList.remove('text-red-600');
                submitButton.disabled = false;
                submitButton.textContent = '신청하기';
                submitButton.classList.remove('bg-gray-400', 'hover:bg-gray-400');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }
        } catch (error) {
            console.error('인원 확인 중 오류 발생:', error);
            countDisplay.textContent = '인원 확인에 실패했습니다.';
            countDisplay.classList.add('text-red-600');
        }
    };

    tripDateInput.addEventListener('change', checkAvailability);
    boardingLocationSelect.addEventListener('change', checkAvailability);

    form.addEventListener('submit', function(event) {
        event.preventDefault();

        // 폼 제출 전 최종 확인
        if (submitButton.disabled) {
            alert('이미 마감된 시간입니다.');
            return;
        }

        const formData = new FormData(form);
        
        fetch(appsScriptUrl, {
            method: 'POST',
            body: formData,
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`서버 응답 오류: ${response.status} ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('서버 응답:', data);
            if (data.result === 'success') {
                form.classList.add('hidden');
                successMessage.classList.remove('hidden');
            } else if (data.result === 'failure' && data.message) {
                alert(data.message);
                checkAvailability(); // 마감 메시지 업데이트
            } else {
                console.error('신청 실패:', data.message);
            }
        })
        .catch(error => {
            console.error('전송 중 오류 발생:', error);
            alert('신청 중 오류가 발생했습니다. 다시 시도해 주세요.');
        });

        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
</script>
</body>
</html>
