<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>이동지원 신청</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#f9fafb; font-family:system-ui,sans-serif; }
.sr-only {
  position:absolute;width:1px;height:1px;
  overflow:hidden;clip:rect(0,0,0,0);
}
</style>
</head>

<body class="flex justify-center p-4">
<main class="w-full max-w-xl bg-white p-6 rounded-xl shadow">

<h1 class="text-2xl font-bold text-center mb-4">이동지원 신청</h1>

<form id="applicationForm" class="space-y-5" novalidate>

<label>이름 (필수)
<input name="name" required class="w-full border p-3 rounded mt-1">
</label>

<label>연락처 (필수)
<input
  id="contact"
  name="contact"
  type="tel"
  inputmode="numeric"
  required
  aria-describedby="contactHelp"
  placeholder="000-0000-0000"
  maxlength="13"
  class="w-full border rounded p-3 mt-1"
>
<p id="contactHelp" class="sr-only">
전화번호는 숫자를 입력하면 자동으로 000-0000-0000 형식으로 입력됩니다.
</p>

</label>

<label>이용 프로그램 (필수)
<select name="program" required class="w-full border p-3 rounded mt-1">
<option value="">선택</option>
<option>[자립] 아이폰 집합교육</option>
<option>[평생] 원데이 클래스</option>
<option>[평생] 댄스 교실</option>
<option>[자립] 오카리나</option>
<option>[자립] 우쿨렐레</option>
<option>[지역] 함께걷기 고고고</option>
<option>[전체] 기타</option>
</select>
</label>

<label>탑승 날짜 (필수)
<input id="tripDate" name="tripDate" type="date" required
class="w-full border p-3 rounded mt-1">
</label>

<label>탑승 장소 및 시간 (필수)
<select id="boardingLocation" name="boardingLocation" required
class="w-full border p-3 rounded mt-1">
<option value="">선택</option>
<option>회기역 2번 출구 - 10시</option>
<option>복지관 - 13시 10분</option>
<option>회기역 2번 출구 - 13시 30분</option>
<option>복지관 - 16시</option>
</select>
</label>

<p id="countDisplay" role="status" aria-live="polite"
class="text-center font-semibold"></p>

<label>하고 싶은 말 (선택)
<textarea name="notes" class="w-full border p-3 rounded mt-1"></textarea>
</label>

<label class="flex items-center gap-2">
<input type="checkbox" name="privacyConsent" required>
개인정보 수집 및 이용 동의 (필수)
</label>

<button id="submitBtn" class="w-full bg-indigo-600 text-white py-4 rounded text-lg font-bold">
신청하기
</button>
</form>

<div id="successMessage" class="hidden text-center mt-6"
role="status" aria-live="assertive">
<p class="text-xl font-bold">신청이 완료되었습니다.</p>13:56 2026-01-08
</div>

</main>

<script>
const appsScriptUrl =
'https://script.google.com/macros/s/AKfycby6FQ8DqFT2oDs7V5KOTPN5pIIucs0fAoQJkBTMgwywJ7KC4lrLPeIMJUV7FNGiiri9wA/exec';

const form = document.getElementById('applicationForm');
const submitBtn = document.getElementById('submitBtn');
const countDisplay = document.getElementById('countDisplay');
const tripDate = document.getElementById('tripDate');
const boarding = document.getElementById('boardingLocation');
const contactInput = document.getElementById('contact');

tripDate.min = new Date().toISOString().split('T')[0];

async function checkCount() {
  if (!tripDate.value || !boarding.value) return;

  countDisplay.textContent = "현황 확인 중...";
  countDisplay.style.color = "gray";
  
  try {
    // 1. 서버에 데이터 요청 (Action, 날짜, 장소 전달)
    const url = `${appsScriptUrl}?action=getCount&date=${tripDate.value}&location=${encodeURIComponent(boarding.value)}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.result === 'success') {
      const currentCount = data.count; 
      const maxLimit = 9; 
      const remaining = maxLimit - currentCount;

      if (currentCount >= maxLimit) {
        countDisplay.innerHTML = `<span style="color:red; font-weight:bold;">⚠️ 해당 시간은 마감되었습니다.</span>`;
        submitBtn.disabled = true;
        submitBtn.style.backgroundColor = "#ccc";
      } else {
        countDisplay.innerHTML = `현재 <span style="color:#4f46e5; font-weight:bold;">${currentCount}명</span> 신청 완료 (잔여 ${remaining}석)`;
        submitBtn.disabled = false;
        submitBtn.style.backgroundColor = "#4f46e5";
      }
    }
  } catch (err) {
    countDisplay.textContent = "네트워크 오류가 발생했습니다.";
    console.error("Error fetching count:", err);
  }
}

tripDate.onchange = checkCount;
boarding.onchange = checkCount;

form.onsubmit = async e => {
  e.preventDefault();
  submitBtn.disabled = true;
  submitBtn.textContent = '신청 중입니다';

  const res = await fetch(appsScriptUrl, {
    method:'POST',
    body:new FormData(form)
  });
  const data = await res.json();

  if (data.result === 'success') {
    form.classList.add('hidden');
    document.getElementById('successMessage').classList.remove('hidden');
  } else {
    alert(data.message || '신청 실패');
    submitBtn.disabled = false;
    submitBtn.textContent = '신청하기';
  }
};
</script>
</body>
</html>
